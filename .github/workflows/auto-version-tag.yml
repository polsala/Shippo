name: auto-version-tag

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  if: ${{ !startsWith(github.event.head_commit.message, 'Bump to v') }}
  bump-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.TAG_PUSH_TOKEN }}
      - name: Ensure Python tomlkit
        run: pip install tomlkit
      - name: Find latest tag
        id: latest
        run: |
          TAG=$(git tag --list 'v*' | sort -V | tail -n1)
          echo "latest=${TAG}" >> $GITHUB_OUTPUT
      - name: Bump version if needed and set output
        id: version
        env:
          LATEST_TAG: ${{ steps.latest.outputs.latest }}
        run: |
          python - <<'PY'
          import os, re, pathlib, tomlkit

          def parse(ver):
              return [int(x) for x in ver.split('.')]

          def bump_patch(ver):
              parts = parse(ver)
              parts[2] += 1
              return '.'.join(str(x) for x in parts)

          root = pathlib.Path('Cargo.toml')
          data = tomlkit.parse(root.read_text())
          curr = data['workspace']['package']['version']
          latest = os.environ.get('LATEST_TAG', '').lstrip('v')
          new_ver = curr
          if latest:
              try:
                  if parse(latest) >= parse(curr):
                      new_ver = bump_patch(latest)
              except Exception:
                  pass
          changed = new_ver != curr
          if changed:
              data['workspace']['package']['version'] = new_ver
              root.write_text(tomlkit.dumps(data))
              for path in pathlib.Path('crates').glob('*/Cargo.toml'):
                  pkg = tomlkit.parse(path.read_text())
                  if 'package' in pkg:
                      pkg['package']['version'] = new_ver
                      path.write_text(tomlkit.dumps(pkg))
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"version={new_ver}\n")
              fh.write(f"changed={'true' if changed else 'false'}\n")
          PY
      - name: Commit version bump
        if: steps.version.outputs.changed == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config user.name "shippo-bot"
          git config user.email "shippo-bot@users.noreply.github.com"
          git add Cargo.toml crates/*/Cargo.toml
          git commit -m "Bump to v$VERSION"
          git push
      - name: Create tag if missing
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG_PUSH_TOKEN: ${{ secrets.TAG_PUSH_TOKEN }}
        run: |
          TAG="v$VERSION"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists; skipping"
            exit 0
          fi

          git config user.name "shippo-bot"
          git config user.email "shippo-bot@users.noreply.github.com"

          git tag "$TAG"

          git remote set-url origin "https://x-access-token:${TAG_PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin "$TAG"
          echo "created $TAG"
